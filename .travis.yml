# ===============================================================================
# ## "Travis CI Environment Variables"
#
# It can be two parts - `global` and `matrix`.
#
# All the `foo=bar` pair can be accessed through `process.env` if under **NodeJS**.
#   e.g. `process.env.foo`.
#
# {@link https://docs.travis-ci.com/user/environment-variables/}
# ===============================================================================
env:
  global:
    # **Encrypted** value of `TRAVIS_ENCRYPTION_KEY`.
    # `TRAVIS_ENCRYPTION_KEY` is used to help do encryption on sensitive data, like
    #   Xcode certificate and provisioning profile, etc.
    # Generated by Travis CI `travis encrypt "TRAVIS_ENCRYPTION_KEY=XXX##XXX".
    - secure: "HK8xFLQbb3DPiiyEc8rN6yhdgHhsN4UrlR9h92qln+aDQHzlmdLWWMN3OuzX5MYx7aSYC46JLVVpTBRXLFtGO1dMTGp6QUgS88YRkR8sQPqowS3T244rCc1lzWkYwSbqucpWOWwL78lYV2v1dOXVlQFnVv9l2c9WBKUnvoIF4cV4LBblHlIIujWnvO3vpRi5ebhNcIgdDBATZjkY/pKL1ZM4Z9xD4SsMjfW4r2Go58vqfGXrk5Xj5l/0eodWOMDkRtMJPXEP+m47FzrdIIePd9eAYkclK9cR8xeMo7sDKwNlt0uXuq4cTptodQYX7jPBn5jt3NbbbPY+rrRrKPA552v6DwXgwj11gCC+7WHP3GfSS3kHG7I0ZUVknqK88du7m2rqygRvQ22BtXEo3bmMxaDZBmu8n/mevTycooU7rm8nAnxhwdoAJQETnWha9/K4EvxZ+gqdQ8KAJJh1hISf/yPemhJRp9F4qlMZJiB7eFvomJhzVdbpsSIt6JNm29bcyV1qyPXPhq2NY2qytaAw0BeCOyL++MeFQ+Y8NhETwx/mS3xm7UU4MODUAG/NrJ5R5mz3yd3REzk5oShN49SCRbqbja0nyyj8kweE6lrgUAwC5ZNHbjwCT6+dd2EvIy36eHKAcOvZSIp11jDAFfAjqcE3jpM4lET/iAIn1ggw6tM="

    # **Encrypted** value of `TRAVIS_ENCRYPTION_IV`.
    # `TRAVIS_ENCRYPTION_IV` is used to help do encryption on sensitive data, like
    #   Xcode certificate and provisioning profile, etc.
    # Generated by Travis CI `travis encrypt "TRAVIS_ENCRYPTION_IV=XXX##XXX".
    - secure: "QfTh2CMUr2+RXLQJnFG8BzeyixXoOfgxxDAVaIyn7n77+YlD+5ZiKbNxqmsfkDZtYMQIeR5bjUMK8FQiAbnkVkZJyRGm7WzKBl/gOahnh3wT/dVuiH0pJeN6Q8tgkFPXqNWVq4GrtWt1A9Hi/NKjyPN6G8HsHJRiTP7Qpk8EEgYByzIKEhnX5zJfRnXKpWPihqYGoTT3b4bSYKs8fS8MZLNCOATRI9UQ4DQ+++JhvyichbhjJnK7yAjaptvYRWau1Cu1S55OYKciQQ6sWG91TheOmMCXYm7u1qV0N1CDYRQMITLXQplOdIDMCYKywOryEzLAh2ZHr6Am8lOOJGBkqLIza9sI/2RSoOP5UNBkGxmBsgVtUBimWh535nkXUlWyMXIbN74okqO4+Jn8Ai7P2zRTsE1rgT5zA/jlHPbCS/gP7oVMmWu2hu9C+CG7JdQ3XFVAJPMaYK9FAuv0ZrDrZwA101usWfdvMxfKeCBbb3nW6586NSJ1EH2P1m4NWEO5Rx5oa9YxK/dmQOoqOrwdSOFk4QRRGdS5fGpDtZej4lGyIgBN+R4G8i1E5ar5O6z5qlz6HCseps4hhYphWCq26EuwLMyAIgZ2XPI4QxGu7RoZdqKXe8PquFXDyg9aPAKULbSM1jtj9FIe2UwuZC7H+Jn96YNx+M/cqyV6BrRvf1M="

    # **Encrypted** value of `KEYCHAIN_PASS`.
    # `KEYCHAIN_PASS` is the **passcode** used when adding certificate to Mac OSX Keychain app.
    # Generated by Travis CI `travis encrypt "KEYCHAIN_PASS=XXX##XXX".
    - secure: "uopiJOvgeMVqP5FafinqzAnTPWpXZWdBH3TAZxCpp70GcwAbsRo8qsufaOoUOJMfxTAHxOJgVBWzayXPQvmhAjVSRJEWCqHEn3W0MUn11IXknQ8uowEgrRVVE7zOpmboMxlr3WVTRIDpdBiqLp6dBQGqusfcieo3HsaZ+S3fLZFBf/ViDrDn8KH9fMacZXzW7SYFbReeadJk14QLQU2WO2upbLgdxrEeIOw8nJxH1vshLhTw1+f/mXKtpSXIsGuNdmxAkdQe/oY9ZBUkur8W8uVIpHylp8wcvQcOJaIPVFBEJZoOWjR+D81g8f5RbbMcfEjmEvKuoSxwCOdYJLl3gmAUGCmeNCx4iukjymBUT+5TfIcQh2d5Yue6Apigs71X0sG6VDsCyONDwV11sB4yFKLVNLhnl0tDQh455LMB0ieIAoUCgL3Y2WGg5rbnP7EwlJxu0c2O/SmcmI7jKxwmbRwv/UNWVC+1SMoKIUUlES+uDzxBK1oR4gCCgj+TaHJaZ0DaBBnws0YeZub9KS1Ace0UHb2CSIRxv6xVT3Xkl9yVb3PTPIFUjhh9UAmEaMrz6484V0S9WV/QGt7kOw0YqaoNk8p8JX+IFguU7u6ize0T/xQml2FPn4Wi2d7oe2EwvXg6intDy09umk5VntLTJu9c+0UN0bTSE2kfFpmDlxw="

    # Flag - if running "Unit Test"
    - UNIT_TEST=true
    # Flag - If building the app.
    - BUILD_APP=true

    # Flag - If building one iOS platform
    - iOS_BUILD=false

    # The **build target** - it determines if need to do "minification" to the code.
    # Its available options follow the setting of **Gulp Flow**.
    # Current options:  build | release
    - BUILD_TARGET="release"

    # The **build environment** - it specifies the changes (both inside app code and
    # outside build settings) based on different environments.
    # Its available options can be customized by **Gulp Flow** config file.
    # Popular options:  development | staging | test | production
    - BUILD_ENV="production"

    # Filename of the **provisioning profile** and **certificate files** (private key file and distribution certificate file).
    # Without "extension".
    # Both private key file and distribution certificate file share the **SAME** filename.
    #
    # NOTES: If the files are encrypted by `travis encrypt-file` which does not do **Base64** encoding.
    # So, when doing decoding, there is no need to add `-a` option.
    - XCODE_PROVISIONING_PROFILE_NAME="xcode-profile-release"
    - XCODE_CERT_NAME="xcode-cert-release"
    # Apple Worldwide Developer Relations Certification Authority certificate
    - XCODE_APPLE_CERT_NAME="Apple-Worldwide-Developer-Relations-Certification-Authority"

    # -------------------------------------------------------------------------------
    # Deployment - HockeyApp
    # -------------------------------------------------------------------------------

    # It MUST be the SAME as the `name` tag of `config.xml`, which is the **App Name** inside Xcode.
    - APP_NAME="Ionic Boilerplate"
    # "Release Notes" of HockeyApp
    - RELEASE_NOTES="HockeyApp Test Upload"

    # HOCKEY_APP_ID
    - secure: "uAJoXF0jDTZivQRPN0UqXmxQOOi4QG6VdG1GeGMwhx5mXIOs7e1KWVgrDiUjVNTcez1b0qWp5YKFi2rv1/svxcln8JJDEGXeldaq/DHQmoO9o3mOm10ae5Cq8Vg/ClCB45HhqXKp+4KvwhiRUgUh5Z0b6QR1DDallJ9pHJfTW9lpz6nbK4PuIiV3pXRxexowCifbCtYjdekyrAJTz77bj2aFKAODkUBtgpflODQU8Oen0KOnQcgKSlJJmA6PUieQq9bqN54mUbZ6bjEQ1zUtHzuVVNqaSH2YKkv+Up2HFWCM/+/0tngQ1s7q27ff8BRGdFIzKZU2yWKVL5ST/y0+NmN0Mj0SBnpbxEIjofEM+ib3BQsMLm18D0iYPZYCNLCJY83abaIQRp4tidAmSVcrAmQgrWPmAsXebvX3HNb6L3dkDHKu63PDuHa8Gvl1Ia4Wnmq8dvEPTxpI3J3/wUmEIeNTeA5dMQ70KwWsd3tZ1usYLw4x9D8ZUxhL/RuLtGKSYHh3Vfx5LA+z82lYka/49xxubW6h76lj9tCQYhKtk9J+L6qJS77I1FoUztmFzqPDoFOIDSjRWKv5ja03+4yNtp9B2jYo8fbg3X6qDUjTa93C51MkWZSSX1aTAn8J0816dd5XwwmhKe0tN2Rm9kvKmBkDzl4JfwemBIFBtBR/3fU="
    # HOCKEY_APP_TOKEN
    - secure: "wdS595kVR5FwA1JWeCHxFCgWcbbnV1gEF7Kvj27fC+7KIOLZ03lckgLkgQNiKxYh+0Qrx++/AxVwGregbeV61o3ALVn+dvkzSxpiehJYuyQ+ch5Ebm7Pfyp+3TNUdKZbD+HmbyF5ZtoV0rTHOyOrZ0cd6fYnCaviYOsOxm30fSrvwhjvBnZSm44myQG7abqcIBBbA64pn7A35jQAJPyDykUpc9tCrUzJ+1od3abM2tsNXSc/angfoPj4iZR46f1XkxhiuuHV1gvh9t/l77n6gjRWVTfk07yCz4W7rGitdOzZWYKRt5Mm7mBVjmSrTY2Nqq3JI1htjuhlcAIgxXZwe67sqd29c+5+lVna5joFC5PUwTXh07gpurNKth3NhGKdLaeHFn+UQ7396r1G+pGvsfTBgJZifiInI6FdSu/bOYDaKJ4ySpDAEbdBhQFbCNd6LnZDTCYqOa059OsUZuI9QB+NkKBRNsW6M8lZnOc6dH+bU2VX4PpiCUh+pNOO1p/bXRrJujOEuJBiSss8/YG0rzmME8QaZVr9ozClrxXzwt60m3hH4TckbOmR6Oz5tx3s5+hfukDJBYuWA9mvflUxJY/1d0HMMHAcJCd1HtavIN5VFyJXjw8RdguFUIuscVk7DfumzyTc2ZbL9Eg+bUZC46i4ysmjrbP4kX/tKXVO0ic="


# ===============================================================================
# ## "Travis CI Working Branches"
#
# It has settings for both **whitelist** (only) and **blacklist** (except)
#
# {@link https://docs.travis-ci.com/user/customizing-the-build/#Building-Specific-Branches}
# ===============================================================================
branches:
  only:
    - master
    - develop

language: objective-c

# OS
os: osx

# Xcode version
osx_image: xcode7.2

# ===============================================================================
# ## "Travis CI Cache"
#
# Trying to cache all **dependencies** by `npm install` and `bower install`
#
# {@link https://docs.travis-ci.com/user/caching/}
# ===============================================================================
cache:
  directories:
  - node_modules/*
  - bower_components/*


# ===============================================================================
# ## "Pre-setup"
#
# If `before_install`, `install` or `before_script` return a non-zero exit code,
# the build is errored and stops immediately.
# ===============================================================================

# -------------------------------------------------------------------------------
# Use `before_install` to set up **prerequisites for installing dependencies** of the build.
# e.g. Upgrade the system
before_install:
  - export LANG=en_US.UTF-8
  - brew update

# -------------------------------------------------------------------------------
# Use `install` to set up the **global** dependencies of the build.
#
install:
  # NPM global packages
  - node -v
  - npm install -g npm@3.0.0
  - npm -v

  # Install `napa` so that we can install `non-NodeJS` package under `node_modules` folder.
  - npm install -g napa
  - npm install -g gulp
  - npm install -g cordova
  - npm install -g ionic
  - npm install -g bower

  # Install `phantomjs` package globally, and then set `PHANTOMJS_BIN`.
  # Otherwise, `karma-phantomjs-launcher` will not find the PhantomJS binary to launch.
  - npm install -g phantomjs
  - export PHANTOMJS_BIN=/usr/lib/node_modules/phantomjs/lib/phantom/bin/phantomjs

  # Do a `npm update` to ensure all dependncies
  - npm update -g

  # Make sure all package works.
  - bower -v
  - gulp -v
  - cordova -v
  - ionic -v

# ===============================================================================
# ## "Script" Sequence
#
# If `script` returns a non-zero exit code, the build is failed, but continues
# to run before being marked as failed.
# ===============================================================================

# -------------------------------------------------------------------------------
# Use `before_script` to set up the **environment** before running the script.
#
# For example:
#
#   - Install local NPM packages
#   - Prepare the building certificates
#
before_script:

  # Local dependencies
  # Use `--unsafe-perm` flag to ensure `napa` is running to intall `non-nodeJS` packages.
  #
  # Ref:
  # If npm was invoked with root privileges, then it will change the uid to the user account or uid specified
  # by the `user` config, which defaults to `nobody`. Set the `unsafe-perm` flag to run scripts with root privileges.
  #
  - npm install --unsafe-perm
  - bower install --allow-root

  # Install `webdriver-manager` for protractor e2e tests
  - ./node_modules/protractor/bin/webdriver-manager update

  # ##--------##
  # Do decryption to files.
  #
  - ./env/scripts/travis-decrypt-files.sh

  # ##--------##
  # Import **build certificate** for Xcode.
  #
  - ./env/scripts/add-xcode-files.sh

# -------------------------------------------------------------------------------
# Use `script` to include the **main** running scripts.
#
# Such as:
#
#   - Running test.
#   - Build releases.
#
script:

  # Build the app from `app` folder to `www` folder.
  - ./env/scripts/build.sh

  # Single Gulp task that runs all inspects and tests, such as `lint`, `unit test`, `e2e test`.
  - ./env/scripts/run-tests.sh

  # ##--------##
  # iOS Build
  #
  - ./env/scripts/build-ios.sh


# -------------------------------------------------------------------------------
# ## "Scripts" running results.
#
# - `after_success` - Perform additional steps when your build succeeds.
# - `after_failure` - Perform additional steps when your build fails.
# The `after_success`, `after_failure`, `after_script` and subsequent stages do not affect the the build result.
#
after_success:

  # Package iOS build
  - ./env/scripts/package-ios.sh

  # Upload the iOS build to HockeyApp.
  - ./env/scripts/upload-ios-hockeyapp.sh

after_failure:

# -------------------------------------------------------------------------------
# Use `after_script` to include stages like cleanning.
#
# It’s the last step in the “normal” build process.
#
# The `after_success`, `after_failure`, `after_script` and subsequent stages do not affect the the build result.
after_script:
  # Remove the files we just added in `before_script`.
  - ./env/scripts/remove-xcode-files.sh


# ===============================================================================
# ## "Deployment"
#
# When deploying files to a provider, prevent Travis CI from resetting your working directory and deleting all changes
# made during the build (`git stash --all`) by adding `skip_cleanup` to your `.travis.yml`:
#
# If you want to make sure that this only runs if your build was successful,
# you can check the `$TRAVIS_TEST_RESULT` environment variable.
# ===============================================================================

# @optional
# You can run steps before a deploy by using the `before_deploy` phase.
# A non-zero exit code in this command will mark the build as errored.
before_deploy: false



# @optional
deploy: false
  # skip_cleanup: true

# @optional
# If there are any steps you’d like to run after the deployment, you can use the `after_deploy` phase.
after_deploy: false


# ===============================================================================
# ## "Send notificaiton"
#
# ===============================================================================

notifications:
#  hipchat: XXXXX@Your Room
